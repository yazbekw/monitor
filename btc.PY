
import schedule
import time
import yfinance as yf
import numpy as np
from datetime import datetime
import requests
import pytz

# Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Telegram - Ø¶Ø¹ Ù‡Ù†Ø§ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø¨ÙˆØªÙƒ
TELEGRAM_BOT_TOKEN = "your_telegram_bot_token_here"
TELEGRAM_CHAT_ID = "your_chat_id_here"


# ØªØ¹Ø±ÙŠÙ Ø§Ù„Ø£ØµÙˆÙ„ Ø§Ù„ØªÙŠ ØªØªØ§Ø¨Ø¹Ù‡Ø§
ASSETS = ["BTC-USD", "ETH-USD", "BNB-USD", "XRP-USD", "ADA-USD"]


# ØªØ­Ø¯ÙŠØ¯ ØªÙˆÙ‚ÙŠØª Ø¯Ù…Ø´Ù‚
DAMASCUS_TZ = pytz.timezone('Asia/Damascus')

# ========== Ø£ÙˆÙ‚Ø§Øª Ø§Ù„Ø´Ø±Ø§Ø¡ Ø§Ù„Ù…Ø«Ù„Ù‰ ==========
BUY_TIMES = [
    {"days": ["tuesday", "wednesday", "thursday"], "start": "01:00"},
    {"days": ["tuesday", "wednesday", "thursday"], "start": "15:00"},
    {"days": ["monday", "friday"], "start": "13:00"},
    {"days": ["sunday", "saturday"], "start": "01:00"},
    {"days": ["saturday"], "start": "16:00"}
]

# ========== Ø£ÙˆÙ‚Ø§Øª Ø§Ù„Ø¨ÙŠØ¹ Ø§Ù„Ù…Ø«Ù„Ù‰ ==========
SELL_TIMES = [
    {"days": ["sunday", "monday"], "start": "17:00"},
    {"days": ["monday"], "start": "00:00"},
    {"days": ["monday"], "start": "07:00"},
    {"days": ["friday"], "start": "00:00"},
    {"days": ["friday"], "start": "05:00"},
    {"days": ["saturday"], "start": "21:00"},
    {"days": ["tuesday", "wednesday", "thursday"], "start": "08:00"}
]

def send_telegram_message(message):
    """Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„Ø© Ø¹Ø¨Ø± Telegram Ù…Ø¹ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø£Ø®Ø·Ø§Ø¡"""
    # ØªÙ‚Ù„ÙŠÙ„ Ø·ÙˆÙ„ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø·ÙˆÙŠÙ„Ø© Ø¬Ø¯Ø§Ù‹
    if len(message) > 4000:
        message = message[:4000] + "...\n\nğŸ“‹ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø·ÙˆÙŠÙ„Ø© Ø¬Ø¯Ø§Ù‹ØŒ ØªÙ… ØªÙ‚ØµÙŠØ±Ù‡Ø§"
    
    url = f"https://api.telegram.org/bot{TELEGRAM_BOT_TOKEN}/sendMessage"
    payload = {
        "chat_id": TELEGRAM_CHAT_ID,
        "text": message,
        "parse_mode": "HTML"
    }
    
    try:
        response = requests.post(url, json=payload, timeout=10)
        if response.status_code == 200:
            print("âœ… ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø± Ø¥Ù„Ù‰ Telegram")
            return True
        else:
            print(f"âŒ Ø®Ø·Ø£ ÙÙŠ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ù„Ø©: {response.status_code}")
            print(f"ğŸ“‹ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø®Ø·Ø£: {response.text}")
            return False
    except Exception as e:
        print(f"âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„: {e}")
        return False

def calculate_rsi(prices, period=14):
    """Ø­Ø³Ø§Ø¨ Ù…Ø¤Ø´Ø± RSI Ø¨Ø´ÙƒÙ„ Ø¯Ù‚ÙŠÙ‚ ÙˆÙ…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø£Ø®Ø·Ø§Ø¡"""
    if len(prices) < period + 1:
        return np.array([50] * len(prices))
    
    deltas = np.diff(prices)
    gains = np.where(deltas > 0, deltas, 0)
    losses = np.where(deltas < 0, -deltas, 0)
    
    avg_gains = np.zeros_like(prices)
    avg_losses = np.zeros_like(prices)
    
    # Ø§Ù„Ù‚ÙŠÙ… Ø§Ù„Ø£ÙˆÙ„ÙŠØ©
    avg_gains[period] = np.mean(gains[:period])
    avg_losses[period] = np.mean(losses[:period])
    
    # Ù…Ø¹Ø§Ù„Ø¬Ø© Ø­Ø§Ù„Ø© Ø§Ù„ØµÙØ± ÙÙŠ Ø§Ù„Ø®Ø³Ø§Ø¦Ø±
    if avg_losses[period] == 0:
        avg_losses[period] = 0.0001  # ØªØ¬Ù†Ø¨ Ø§Ù„Ù‚Ø³Ù…Ø© Ø¹Ù„Ù‰ Ø§Ù„ØµÙØ±
    
    for i in range(period + 1, len(prices)):
        avg_gains[i] = (avg_gains[i-1] * (period-1) + gains[i-1]) / period
        avg_losses[i] = (avg_losses[i-1] * (period-1) + losses[i-1]) / period
        
        # ØªØ¬Ù†Ø¨ Ø§Ù„Ù‚Ø³Ù…Ø© Ø¹Ù„Ù‰ Ø§Ù„ØµÙØ±
        if avg_losses[i] == 0:
            avg_losses[i] = 0.0001
    
    rs = avg_gains / avg_losses
    rsi = 100 - (100 / (1 + rs))
    rsi[:period] = 50
    
    return rsi

def get_market_data(symbol):
    """Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø³ÙˆÙ‚ Ù…Ø¹ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø£Ø®Ø·Ø§Ø¡"""
    try:
        stock = yf.Ticker(symbol)
        hist = stock.history(period="1mo", interval="1d")
        
        if len(hist) < 15:
            print(f"âš ï¸ Ø¨ÙŠØ§Ù†Ø§Øª ØºÙŠØ± ÙƒØ§ÙÙŠØ© Ù„Ù€ {symbol}")
            return None, None, None
            
        current_price = hist['Close'].iloc[-1]
        rsi_values = calculate_rsi(hist['Close'].values)
        current_rsi = rsi_values[-1]
        
        # Ø³Ø¹Ø± Ø§Ù„Ø£Ù…Ø³ Ù„Ù„ØªØºÙŠÙŠØ±
        prev_price = hist['Close'].iloc[-2] if len(hist) > 1 else current_price
        price_change = ((current_price - prev_price) / prev_price) * 100
        
        return current_price, current_rsi, price_change
        
    except Exception as e:
        print(f"âŒ Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª {symbol}: {e}")
        return None, None, None

def get_rsi_recommendation(rsi, is_buy_time):
    """Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ ØªÙˆØµÙŠØ© Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ RSI"""
    if is_buy_time:
        if rsi < 30:
            return "Ø¥Ø´Ø§Ø±Ø© Ø´Ø±Ø§Ø¡ Ù‚ÙˆÙŠØ© Ø¬Ø¯Ø§Ù‹", "ğŸ¯", "ğŸŸ¢"
        elif rsi < 35:
            return "Ø¥Ø´Ø§Ø±Ø© Ø´Ø±Ø§Ø¡ Ù‚ÙˆÙŠØ©", "ğŸ‘", "ğŸŸ¢"
        elif rsi < 40:
            return "Ø¥Ø´Ø§Ø±Ø© Ø´Ø±Ø§Ø¡ Ø¬ÙŠØ¯Ø©", "ğŸ“ˆ", "ğŸŸ¡"
        else:
            return "ØªØ¬Ù†Ø¨ Ø§Ù„Ø´Ø±Ø§Ø¡ (RSI Ù…Ø±ØªÙØ¹)", "âš ï¸", "ğŸ”´"
    else:
        if rsi > 70:
            return "Ø¥Ø´Ø§Ø±Ø© Ø¨ÙŠØ¹ Ù‚ÙˆÙŠØ© Ø¬Ø¯Ø§Ù‹", "ğŸ¯", "ğŸŸ¢"
        elif rsi > 65:
            return "Ø¥Ø´Ø§Ø±Ø© Ø¨ÙŠØ¹ Ù‚ÙˆÙŠØ©", "ğŸ‘", "ğŸŸ¢"
        elif rsi > 60:
            return "Ø¥Ø´Ø§Ø±Ø© Ø¨ÙŠØ¹ Ø¬ÙŠØ¯Ø©", "ğŸ“ˆ", "ğŸŸ¡"
        else:
            return "ØªØ¬Ù†Ø¨ Ø§Ù„Ø¨ÙŠØ¹ (RSI Ù…Ù†Ø®ÙØ¶)", "âš ï¸", "ğŸ”´"

def check_trading_opportunity(is_buy_time):
    """ÙØ­Øµ ÙØ±Øµ Ø§Ù„ØªØ¯Ø§ÙˆÙ„ ÙˆØ¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª"""
    action = "Ø´Ø±Ø§Ø¡" if is_buy_time else "Ø¨ÙŠØ¹"
    action_emoji = "ğŸŸ¢" if is_buy_time else "ğŸ”´"
    
    current_time = datetime.now(DAMASCUS_TZ).strftime("%Y-%m-%d %H:%M")
    
    message = f"{action_emoji} <b>Ø¥Ø´Ø¹Ø§Ø± ØªØ¯Ø§ÙˆÙ„ - ÙˆÙ‚Øª {action}</b>\n"
    message += f"â° <i>{current_time}</i>\n"
    message += "â”€" * 30 + "\n\n"
    
    assets_analyzed = 0
    
    for symbol in ASSETS:
        data = get_market_data(symbol)
        if all(x is not None for x in data):
            price, rsi, change = data
            assets_analyzed += 1
            
            rec_text, rec_emoji, color_emoji = get_rsi_recommendation(rsi, is_buy_time)
            change_emoji = "ğŸ“ˆ" if change >= 0 else "ğŸ“‰"
            change_sign = "+" if change >= 0 else ""
            
            message += f"{color_emoji} <b>{symbol}</b>\n"
            message += f"ğŸ’° Ø§Ù„Ø³Ø¹Ø±: ${price:,.2f} {change_emoji} {change_sign}{change:.2f}%\n"
            message += f"ğŸ“Š RSI: {rsi:.1f} - {rec_emoji} {rec_text}\n"
            message += "â”€" * 20 + "\n"
    
    if assets_analyzed > 0:
        message += f"\nğŸ“‹ <i>ØªÙ… ØªØ­Ù„ÙŠÙ„ {assets_analyzed} Ø£ØµÙ„</i>"
        
        # ØªÙ‚Ø³ÙŠÙ… Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø·ÙˆÙŠÙ„Ø©
        if len(message) > 2000:
            parts = [message[i:i+2000] for i in range(0, len(message), 2000)]
            for part in parts:
                send_telegram_message(part)
                time.sleep(1)
        else:
            send_telegram_message(message)
    else:
        print("âš ï¸ Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù…ØªØ§Ø­Ø© Ù„Ù„ØªØ­Ù„ÙŠÙ„")
        send_telegram_message("âš ï¸ <b>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù…ØªØ§Ø­Ø© Ù„Ù„ØªØ­Ù„ÙŠÙ„ Ø­Ø§Ù„ÙŠØ§Ù‹</b>")

def send_daily_report():
    """Ø¥Ø±Ø³Ø§Ù„ ØªÙ‚Ø±ÙŠØ± ÙŠÙˆÙ…ÙŠ Ù…Ø®ØªØµØ±"""
    current_time = datetime.now(DAMASCUS_TZ).strftime("%Y-%m-%d %H:%M")
    
    message = f"ğŸ“Š <b>Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„ÙŠÙˆÙ…ÙŠ Ø§Ù„Ù…Ø®ØªØµØ±</b>\n"
    message += f"â° <i>{current_time}</i>\n"
    message += "â”€" * 30 + "\n\n"
    
    assets_analyzed = 0
    
    for symbol in ASSETS:
        data = get_market_data(symbol)
        if all(x is not None for x in data):
            price, rsi, change = data
            assets_analyzed += 1
            
            status = "ğŸŸ¢ Ù…Ù†Ø®ÙØ¶" if rsi < 35 else "ğŸ”´ Ù…Ø±ØªÙØ¹" if rsi > 65 else "ğŸŸ¡ Ù…ØªØ¹Ø§Ø¯Ù„"
            change_emoji = "ğŸ“ˆ" if change >= 0 else "ğŸ“‰"
            
            message += f"â€¢ {status} <b>{symbol}</b>: ${price:,.2f} {change_emoji}\n"
    
    if assets_analyzed > 0:
        message += f"\nğŸ“ˆ RSI < 35: ÙØ±ØµØ© Ø´Ø±Ø§Ø¡\n"
        message += f"ğŸ“‰ RSI > 65: ÙØ±ØµØ© Ø¨ÙŠØ¹\n"
        message += f"ğŸ“‹ {assets_analyzed} Ø£ØµÙ„ ØªÙ… ØªØ­Ù„ÙŠÙ„Ù‡"
        
        send_telegram_message(message)
    else:
        send_telegram_message("âš ï¸ <b>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„ÙŠÙˆÙ…ÙŠ</b>")

def schedule_notifications():
    """Ø¬Ø¯ÙˆÙ„Ø© Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª"""
    
    # Ø¬Ø¯ÙˆÙ„Ø© Ø£ÙˆÙ‚Ø§Øª Ø§Ù„Ø´Ø±Ø§Ø¡
    for time_slot in BUY_TIMES:
        for day in time_slot["days"]:
            getattr(schedule.every(), day).at(time_slot["start"]).do(
                lambda: check_trading_opportunity(True)
            )

    # Ø¬Ø¯ÙˆÙ„Ø© Ø£ÙˆÙ‚Ø§Øª Ø§Ù„Ø¨ÙŠØ¹
    for time_slot in SELL_TIMES:
        for day in time_slot["days"]:
            getattr(schedule.every(), day).at(time_slot["start"]).do(
                lambda: check_trading_opportunity(False)
            )

    # ØªÙ‚Ø±ÙŠØ± ÙŠÙˆÙ…ÙŠ Ø§Ù„Ø³Ø§Ø¹Ø© 8 Ù…Ø³Ø§Ø¡Ù‹
    schedule.every().day.at("20:00").do(send_daily_report)

def main():
    """Ø§Ù„Ø¯Ø§Ù„Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©"""
    print("ğŸš€ Ø¨Ø¯Ø¡ Ù†Ø¸Ø§Ù… Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø§Ù„ØªØ¯Ø§ÙˆÙ„ Ø§Ù„Ù…ØªÙ‚Ø¯Ù…...")
    print(f"ğŸ“Š Ø¹Ø¯Ø¯ Ø§Ù„Ø£ØµÙˆÙ„ Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø©: {len(ASSETS)}")
    
    # Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø±Ø³Ø§Ù„Ø© Ù…Ø®ØªØµØ±Ø©
    test_msg = send_telegram_message("âœ… <b>ØªÙ… ØªÙØ¹ÙŠÙ„ Ù†Ø¸Ø§Ù… Ø§Ù„ØªØ¯Ø§ÙˆÙ„ Ø¨Ù†Ø¬Ø§Ø­!</b>")
    
    if test_msg:
        print("âœ… Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù€ Telegram Ù†Ø§Ø¬Ø­!")
    else:
        print("âŒ ÙŠØ±Ø¬Ù‰ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Telegram")
        return
    
    # Ø¬Ø¯ÙˆÙ„Ø© Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª
    schedule_notifications()
    
    print("\n" + "="*50)
    print("ğŸ¯ Ø§Ù„Ù†Ø¸Ø§Ù… ÙŠØ¹Ù…Ù„ Ø¨Ù†Ø¬Ø§Ø­! Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ù…Ø¬Ø¯ÙˆÙ„Ø©.")
    print("â° Ø³ÙŠØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø­Ø³Ø¨ Ø§Ù„Ø£ÙˆÙ‚Ø§Øª Ø§Ù„Ù…Ø­Ø¯Ø¯Ø©")
    print("="*50 + "\n")
    
    # Ø§Ù„Ø­Ù„Ù‚Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
    while True:
        try:
            schedule.run_pending()
            time.sleep(1)
        except KeyboardInterrupt:
            print("\nâ¹ï¸ Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ù†Ø¸Ø§Ù…...")
            send_telegram_message("â¹ï¸ <b>ØªÙ… Ø¥ÙŠÙ‚Ø§Ù Ù†Ø¸Ø§Ù… Ø§Ù„ØªØ¯Ø§ÙˆÙ„</b>")
            break
        except Exception as e:
            print(f"âŒ Ø®Ø·Ø£ ØºÙŠØ± Ù…ØªÙˆÙ‚Ø¹: {e}")
            time.sleep(60)

if __name__ == "__main__":

    main()
